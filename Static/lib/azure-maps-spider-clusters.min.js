/* MIT License - Copyright (c) Microsoft Corporation. */


!function(e,g){"use strict";var r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};var v,t,i,a=(v=g.internal.EventEmitter,r(t=o,i=v),t.prototype=null===i?Object.create(i):(s.prototype=i.prototype,new s),o.prototype.dispose=function(){var e=this,t=e._map,r=t.events,i=e._spiderFeatureLayer,a=e._layerClickEvent,s=e.hideSpiderCluster;r.remove("click",s),r.remove("movestart",s),r.remove("click",e._clusterLayer,a),r.remove("mouseleave",i,e._unhighlightStick),r.remove("mousemove",i,e._highlightStick),r.remove("click",i,a),r.remove("click",e._unclustedLayer,a),t.layers.remove(i),e._spiderFeatureLayer=null,t.layers.remove(e._spiderLineLayer),e._spiderLineLayer=null,e._spiderDataSource.clear(),t.sources.remove(e._spiderDataSource),e._spiderDataSource=null},o.prototype.setOptions=function(e){var t=this,r=t._options;this.hideSpiderCluster(),e&&("number"==typeof e.circleSpiralSwitchover&&(r.circleSpiralSwitchover=e.circleSpiralSwitchover),"number"==typeof e.maxFeaturesInWeb&&(r.maxFeaturesInWeb=e.maxFeaturesInWeb),"number"==typeof e.minSpiralAngleSeperation&&(r.minSpiralAngleSeperation=e.minSpiralAngleSeperation),"number"==typeof e.spiralDistanceFactor&&(r.spiralDistanceFactor=e.spiralDistanceFactor),"number"==typeof e.minCircleLength&&(r.minCircleLength=e.minCircleLength),e.stickLayerOptions&&(r.stickLayerOptions=e.stickLayerOptions,t._spiderLineLayer.setOptions(e.stickLayerOptions)),"boolean"==typeof e.visible&&r.visible!==e.visible&&(r.visible=e.visible,t._spiderLineLayer.setOptions({visible:e.visible}),t._spiderFeatureLayer.setOptions({visible:e.visible})))},o.prototype.showSpiderCluster=function(_){var m=this,S=this,y=S._options;S.hideSpiderCluster(),_&&_.properties.cluster&&S._datasource.getClusterLeaves(_.properties.cluster_id,y.maxFeaturesInWeb,0).then(function(e){var t,r,i,a=_.geometry.coordinates,s=S._map.positionsToPixels([a])[0],o=0,n=e.length>y.circleSpiralSwitchover;n?(t=y.minCircleLength/Math.PI,i=2*Math.PI*y.spiralDistanceFactor):(r=2*Math.PI/e.length,(t=y.spiralDistanceFactor/r/Math.PI/2*e.length)<y.minCircleLength&&(t=y.minCircleLength));for(var c=[],l=0,p=e.length;l<p;l++){n?t+=i/(o+=y.minSpiralAngleSeperation/t+5e-4*l):o=r*l;var u=S._map.pixelsToPositions([[s[0]+t*Math.cos(o),s[1]+t*Math.sin(o)]])[0];c.push(new g.data.Feature(new g.data.LineString([a,u]),null,l+""));var d=e[l],h=d instanceof g.Shape?d.getId():d.id,v=Object.assign({},d instanceof g.Shape?d.getProperties():d.properties);v._stickId=l+"",v._parentId=h,c.push(new g.data.Feature(new g.data.Point(u),v))}m._spiderDataSource.add(c)})},o);function s(){this.constructor=t}function o(e,t,r,i){var o=v.call(this)||this;o._hoverStateId=null,o._options={circleSpiralSwitchover:6,minCircleLength:30,minSpiralAngleSeperation:25,spiralDistanceFactor:5,maxFeaturesInWeb:100,stickLayerOptions:{strokeColor:["case",["boolean",["feature-state","hover"],!1],"red","black"]}},o.hideSpiderCluster=function(){o._spiderDataSource.clear()},o._layerClickEvent=function(e){var t=o;if(e&&e.shapes&&0<e.shapes.length){var r,i=void 0,a=void 0,s=void 0;r=e.shapes[0]instanceof g.Shape?(i=(a=e.shapes[0]).getProperties(),a.getCoordinates()):(i=(s=e.shapes[0]).properties,s.geometry.coordinates),s&&i.cluster?(t._invokeEvent("featureUnselected",null),t._currentCluster=e.shapes[0],i.point_count>t._options.maxFeaturesInWeb?t._datasource.getClusterExpansionZoom(i.cluster_id).then(function(e){t._map.setCamera({center:r,zoom:e})}):t.showSpiderCluster(s)):(void 0!==i._parentId?a=t._datasource.getShapeById(i._parentId):t._currentCluster=null,a&&t._invokeEvent("featureSelected",{cluster:t._currentCluster,shape:a}),t.hideSpiderCluster()),e.preventDefault()}},o._highlightStick=function(e){var t=o;if(e&&e.shapes&&0<e.shapes.length){var r=void 0;r=e.shapes[0]instanceof g.Shape?e.shapes[0].getProperties()._stickId:e.shapes[0].properties._stickId;var i={source:t._spiderDatasourceId,id:t._hoverStateId},a=t._map;t._hoverStateId&&a.map.setFeatureState(i,{hover:!1}),t._hoverStateId=r,i.id=r,a.map.setFeatureState(i,{hover:!0}),a.getCanvasContainer().style.cursor="pointer"}},o._unhighlightStick=function(e){var t=o;t._hoverStateId&&(t._map.map.setFeatureState({source:t._spiderDatasourceId,id:t._hoverStateId},{hover:!1}),t._hoverStateId=null,t._map.getCanvasContainer().style.cursor="grab")};var a=o,s=g.layer;a._map=e;var n=(a._clusterLayer=t).getSource();if("string"==typeof n&&(n=e.sources.getById(n)),!(n instanceof g.source.DataSource))throw"Data source on cluster layer is not supported.";a._datasource=n,i=i||{};var c=new g.source.DataSource;a._spiderDataSource=c,e.sources.add(c),a._spiderDatasourceId=c.getId(),a._spiderLineLayer=new s.LineLayer(c,null,a._options.stickLayerOptions),e.layers.add(a._spiderLineLayer);var l,p=Object.assign({},r.getOptions());p.source=void 0,p.filter=["any",["==",["geometry-type"],"Point"],["==",["geometry-type"],"MultiPoint"]],l=(a._unclustedLayer=r)instanceof s.BubbleLayer?new s.BubbleLayer(c,null,p):(p.iconOptions=p.iconOptions||{},Object.assign(p.iconOptions,{allowOverlap:!0,ignorePlacement:!0}),new s.SymbolLayer(c,null,p)),a._spiderFeatureLayer=l,e.layers.add(l),a.setOptions(i);var u=e.events,d=a._layerClickEvent,h=a.hideSpiderCluster;return u.add("click",h),u.add("movestart",h),u.add("mouseleave",l,a._unhighlightStick),u.add("mousemove",l,a._highlightStick),u.add("click",t,d),u.add("click",l,d),u.add("click",r,d),o}e.SpiderClusterManager=a}(this.atlas=this.atlas||{},atlas);
